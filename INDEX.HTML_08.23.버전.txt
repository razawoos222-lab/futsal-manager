<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>í’‹ì‚´ ë§¤ë‹ˆì € 2.0</title>
    <!-- ë·°í¬íŠ¸ ì„¤ì • ìµœì í™”: ì•„ì´í° ë“± ëª¨ë°”ì¼ ê¸°ê¸° í™”ë©´ì— ê½‰ ì°¨ê²Œ í‘œì‹œ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <!-- Tailwind CSS CDNì„ ì‚¬ìš©í•˜ì—¬ ìŠ¤íƒ€ì¼ì„ ì ìš©í•©ë‹ˆë‹¤. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ê°€ë…ì„±ì„ ë†’ì´ê¸° ìœ„í•´ 'Noto Sans KR' í°íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* Custom colors for dark theme */
        :root {
            --color-primary-bg: #1A202C; /* Dark blue-gray */
            --color-card-bg: #2D3748;    /* Slightly lighter dark blue-gray */
            --color-text-main: #E2E8F0; /* Light gray */
            --color-text-secondary: #94A3B8; /* Medium gray */
            --color-accent-blue: rgb(133,173,197); /* User requested color */
        }
        /* ì „ì²´ì ì¸ ë””ìì¸: ë‹¤í¬ í…Œë§ˆë¡œ ë³€ê²½ */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--color-primary-bg);
            color: var(--color-text-main);
            -webkit-tap-highlight-color: transparent; /* ëª¨ë°”ì¼ í„°ì¹˜ ì‹œ í•˜ì´ë¼ì´íŠ¸ ì œê±° */
        }
        /* ì¹´ë“œí˜• UIì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ì„ ì •ì˜í•©ë‹ˆë‹¤. */
        .card {
            background-color: var(--color-card-bg);
            border-radius: 1rem; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            padding: 1.5rem; /* ë‚´ë¶€ ì—¬ë°± */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* ë²„íŠ¼ì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ì„ ì •ì˜í•©ë‹ˆë‹¤. */
        .btn {
            padding: 1.25rem 2rem; /* ë²„íŠ¼ í¬ê¸°ë¥¼ í¬ê²Œ ë§Œë“­ë‹ˆë‹¤. */
            border-radius: 0.75rem; /* ëª¨ì„œë¦¬ë¥¼ ë‘¥ê¸€ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤. */
            font-weight: 900; /* í°íŠ¸ë¥¼ ë” êµµê²Œ ë§Œë“­ë‹ˆë‹¤. */
            transition: background-color 0.2s;
            text-align: center;
            white-space: nowrap; /* ë²„íŠ¼ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
            color: #FFFFFF; /* ë²„íŠ¼ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        }
        .btn-primary { background-color: #3B82F6; }
        .btn-primary:hover { background-color: #2563EB; }
        .btn-secondary { background-color: #6B7280; } /* ì–´ë‘ìš´ íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        .btn-secondary:hover { background-color: #4B5563; }
        .btn-danger { background-color: #EF4444; }
        .btn-danger:hover { background-color: #DC2626; }
        /* í”Œë ˆì´ì–´ ì¹´ë“œ (ì°¸ì„ ì¡°ì‚¬) */
        .player-card {
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--color-card-bg); /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
            color: var(--color-text-main); /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
        }
        .player-card.selected {
            background-color: #3B82F6;
            color: #FFFFFF;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
        }
        /* íŒ€ ì¹´ë“œ (ê²½ê¸° ì„ íƒ) */
        .team-card {
            background-color: var(--color-card-bg); /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
            color: var(--color-text-main); /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
            border-color: #4B5563; /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
        }
        .team-card.selected {
            transform: scale(1.02);
            border-color: var(--color-accent-blue); /* Accent ìƒ‰ìƒ ì ìš© */
            box-shadow: 0 0 15px rgba(133,173,197, 0.5); /* Accent ìƒ‰ìƒ ì ìš© */
        }
        /* íƒ­ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .tab-button {
            padding: 1.25rem 1.75rem; /* íƒ­ ë²„íŠ¼ í¬ê¸° í‚¤ì›€ */
            border-bottom: 3px solid transparent;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.875rem; /* íƒ­ ê¸€ì”¨ í¬ê¸° í‚¤ì›€ */
            color: var(--color-text-secondary); /* ê¸°ë³¸ íƒ­ ê¸€ì”¨ìƒ‰ */
        }
        .tab-button.active {
            color: var(--color-accent-blue); /* Accent ìƒ‰ìƒ ì ìš© */
            border-color: var(--color-accent-blue); /* Accent ìƒ‰ìƒ ì ìš© */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* ê¸°ë¡ ìˆ˜ì • í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ì˜¤ëŠ˜ì˜ ê²½ê¸° ê²°ê³¼ í™”ë©´) */
        .edit-table {
            border-collapse: collapse; /* í…Œì´ë¸” ì…€ ê²½ê³„ì„  í•©ì¹˜ê¸° */
            width: 100%;
        }
        .edit-table th, .edit-table td {
            padding: 0.75rem;
            text-align: center;
            font-size: 1.25rem; /* í°íŠ¸ í‚¤ì›€ */
            border-bottom: 1px solid #4B5563; /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
        }
        .edit-table th {
            background-color: var(--color-card-bg); /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
            font-weight: bold;
            color: var(--color-text-main); /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
        }
        .edit-table tbody tr:nth-child(odd) {
            background-color: var(--color-primary-bg); /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
        }
        .edit-table tbody tr:nth-child(even) {
            background-color: var(--color-card-bg); /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
        }
        .edit-table input[type="number"] {
            width: 80px; /* ì…ë ¥ ì¹¸ ë„“í˜ */
            padding: 0.5rem; /* íŒ¨ë”© í‚¤ì›€ */
            background-color: var(--color-primary-bg); /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
            border: 1px solid #4B5563; /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
            border-radius: 0.25rem;
            color: var(--color-text-main); /* ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ë³€ê²½ */
            text-align: center;
            font-size: 1.25rem; /* í°íŠ¸ í‚¤ì›€ */
        }
        /* íŠ¹ì • í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì¡°ì • (ë‹¤í¬ í…Œë§ˆì— ë§ì¶°) */
        .text-gray-700 { color: var(--color-text-secondary); }
        .text-gray-800 { color: var(--color-text-main); }
        .text-gray-900 { color: var(--color-text-main); }
        .text-zinc-300 { color: var(--color-text-secondary); }
        .text-zinc-400 { color: var(--color-text-secondary); }
        .text-zinc-500 { color: var(--color-text-secondary); }
        .bg-gray-200 { background-color: #4B5563; } /* Player button bg, dark theme */
        .text-gray-900 { color: var(--color-text-main); } /* Player button text, dark theme */


        /* MVP ì¹´ë“œ ë° í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì¡°ì • (ë‹¤í¬ í…Œë§ˆì— ë§ì¶°) */
        .bg-yellow-100 { background-color: #4A4030; } /* Darker yellow background */
        .text-yellow-900 { color: #FCD34D; } /* Brighter yellow text */
        .text-yellow-600 { color: #FCD34D; } /* Brighter yellow text */
        .text-red-600 { color: #EF4444; } /* Red for team/stats */
        .text-blue-600 { color: #3B82F6; } /* Blue for team/stats */
        .text-green-600 { color: #22C55E; } /* Green for stats */
        .text-purple-600 { color: #A855F7; } /* Purple for stats */
        .text-orange-600 { color: #F97316; } /* Orange for stats */
        .text-teal-600 { color: #14B8A6; } /* Teal for stats */


      /* ì»¤ìŠ¤í…€ ì£¼ì¥ ì™„ì¥ ìŠ¤íƒ€ì¼ */
      .armband {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 4px;
        font-weight: 900;
        font-size: 16px;
        color: black;
      }
      .captain-armband {
        background-color: #FBBF24; /* ë…¸ë€ìƒ‰ */
      }
      .vice-captain-armband {
        background-color: #D1D5DB; /* ì€ìƒ‰ */
      }
     
    </style>
</head>
<body class="p-5 md:p-8 antialiased">
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´: ì„œë²„ í†µì‹  ì¤‘ ì‚¬ìš©ìì—ê²Œ ë¡œë”© ì¤‘ì„ì„ ì•Œë¦½ë‹ˆë‹¤. -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-24 w-24 border-t-4 border-b-4 border-blue-500"></div>
    </div>
    <!-- ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼: ê° í™”ë©´ì—ì„œ ì´ì „ í™”ë©´ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. -->
    <button id="btn-back" data-action="go-back" class="hidden fixed top-4 left-4 bg-gray-700 text-white w-14 h-14 rounded-full text-3xl z-40 shadow-lg flex items-center justify-center hover:bg-gray-600 transition-colors">â†</button>


    <!-- 1. ì°¸ì„ ì¡°ì‚¬ í™”ë©´ -->
    <div id="screen-attendance" class="hidden w-full max-w-2xl mx-auto text-center space-y-8">
        <h1 class="text-6xl font-black mb-4">ì°¸ì„ ì¡°ì‚¬</h1>
        <!-- ê²½ê¸° ë‚ ì§œ ì„ íƒê¸° ì¶”ê°€ -->
        <div class="card p-4 flex flex-col items-center space-y-4">
            <label for="game-date" class="text-3xl font-bold">ê²½ê¸° ë‚ ì§œ ì„ íƒ:</label>
            <input type="date" id="game-date" class="w-full max-w-xs p-3 rounded-lg bg-gray-700 text-gray-100 text-2xl font-semibold border border-gray-500">
        </div>
        <div class="card"><h2 class="text-4xl font-bold">ì°¸ì„ ì¸ì›: <span id="attendance-count">0</span>ëª…</h2></div>
        <!-- ì„ ìˆ˜ ëª©ë¡ì„ í‘œì‹œí•˜ëŠ” ê·¸ë¦¬ë“œì…ë‹ˆë‹¤. (ATT/DEF ì œê±°) -->
        <div id="master-player-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-left max-h-[60vh] overflow-y-auto p-2"></div>
        <!-- 'íŒ€ ë°°ë¶„í•˜ê¸°' ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ 'ì°¸ì„ ì™„ë£Œ'ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. -->
        <button data-action="go-to-allocation" class="btn btn-primary w-full text-3xl">ì°¸ì„ ì™„ë£Œ</button>
    </div>


    <!-- 2. íŒ€ ë°°ë¶„ & ë¼ì¸ì—… í™”ë©´ -->
    <div id="screen-team-allocation" class="hidden w-full max-w-5xl mx-auto text-center space-y-8">
        <h1 class="text-6xl font-black mb-4">íŒ€ ë°°ë¶„ & ë¼ì¸ì—…</h1>
        <div class="flex flex-col sm:flex-row gap-4">
            <!-- íŒ€ ë°°ë¶„ ì•Œê³ ë¦¬ì¦˜ ì„ íƒ ë“œë¡­ë‹¤ìš´ (ìƒˆë¡œìš´ ì˜µì…˜ ì¶”ê°€) -->
            <select id="assignment-strategy" class="w-full p-4 rounded-xl bg-gray-700 text-gray-100 border border-gray-500 font-semibold text-4xl">
                <option value="balanced">ë°¸ëŸ°ìŠ¤ (ì¶”ì²œ)</option>
                <option value="random">ëœë¤</option>
                <option value="antiReunion">ì¬íšŒ ë°©ì§€ (ìƒˆë¡œìš´ ì¡°í•©)</option>
                <option value="tacticalRole">ì „ìˆ  ì—­í•  ê¸°ë°˜ (í¬ì§€ì…˜ ê· í˜•)</option>
                <option value="winLossBalance">ìŠ¹íŒ¨ ê· í˜• ì¡°ì • (ë™ê¸° ë¶€ì—¬)</option>
            </select>
            <!-- ë‹¤ì‹œ ë°°ë¶„ ë²„íŠ¼ -->
            <button data-action="re-allocate" class="btn btn-secondary text-3xl px-8">ğŸ”„ ë‹¤ì‹œ ë°°ë¶„</button>
        </div>
        <!-- íŒ€ ë°°ë¶„ ê²°ê³¼ë¥¼ í‘œì‹œí•˜ëŠ” ì»¨í…Œì´ë„ˆì…ë‹ˆë‹¤. í™”ë©´ ë„ˆë¹„ì— ê½‰ ì°¨ê²Œ ì¡°ì •ë©ë‹ˆë‹¤. -->
        <div id="team-allocation-container" class="flex flex-col gap-6"></div> <!-- ê°€ë¡œê°€ ì•„ë‹Œ ì„¸ë¡œë¡œ ë°°ì¹˜ -->
        <!-- 'ê²½ê¸° ì¤€ë¹„ ì™„ë£Œ' ë²„íŠ¼ë§Œ ë‚¨ê¸°ê³ , ë‹¤ë¥¸ ë²„íŠ¼ì€ ì œê±°í–ˆìŠµë‹ˆë‹¤. -->
        <button data-action="go-to-match-select" class="btn btn-primary w-full text-3xl">ê²½ê¸° ì¤€ë¹„ ì™„ë£Œ</button>
    </div>
   
    <!-- 3. ê²½ê¸° ì„ íƒ í™”ë©´ -->
    <div id="screen-match-select" class="hidden w-full max-w-4xl mx-auto text-center space-y-8">
        <h1 class="text-7xl font-black mb-4">ê²½ê¸° ì„ íƒ</h1>
        <!-- ê²½ê¸° ì‹œê°„ ì„¤ì • ë“œë¡­ë‹¤ìš´ ì¶”ê°€ -->
        <div class="card p-4 flex flex-col items-center space-y-4">
            <label for="match-duration" class="text-3xl font-bold">ê²½ê¸° ì‹œê°„ ì„¤ì •:</label>
            <select id="match-duration" class="w-full max-w-xs p-4 rounded-lg bg-gray-700 text-gray-100 text-3xl font-semibold border border-gray-500">
                <option value="300">5ë¶„</option>
                <option value="420">7ë¶„</option>
                <option value="600" selected>10ë¶„</option>
                <option value="720">12ë¶„</option>
                <option value="900">15ë¶„</option>
            </select>
        </div>
        <!-- êµ¬ì¥ëª… ì„ íƒ ë“œë¡­ë‹¤ìš´ ì¶”ê°€ -->
        <div class="card p-4 flex flex-col items-center space-y-4">
            <label for="field-select" class="text-3xl font-bold">êµ¬ì¥ëª… ì„ íƒ:</label>
            <select id="field-select" class="w-full max-w-xs p-4 rounded-lg bg-gray-700 text-gray-100 text-3xl font-semibold border border-gray-500">
                <option value="A êµ¬ì¥">A êµ¬ì¥</option>
                <option value="B êµ¬ì¥">B êµ¬ì¥</option>
                <option value="C êµ¬ì¥">C êµ¬ì¥</option>
            </select>
        </div>
        <p class="text-2xl text-gray-400">ê²½ê¸°ë¥¼ ì§„í–‰í•  2íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.</p>
        <div id="team-select-container" class="flex flex-col gap-6"></div> <!-- ì„¸ë¡œë¡œ ë°°ì¹˜ -->
        <!-- ê²½ê¸° ì‹œì‘ ë²„íŠ¼ ì¶”ê°€ -->
        <button id="btn-start-match" data-action="start-selected-match" class="btn btn-primary w-full text-3xl opacity-50 cursor-not-allowed" disabled>ê²½ê¸° ì‹œì‘</button>
    </div>


    <!-- 4. ìŠ¤ì½”ì–´ ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
    <div id="screen-match-controller" class="hidden w-full max-w-5xl mx-auto text-center"></div>
   
    <!-- 5. ì„¸ì…˜ ìš”ì•½ ë° ê¸°ë¡ ìˆ˜ì • í™”ë©´ (ì‹ ê·œ) -->
    <div id="screen-session-summary" class="hidden w-full max-w-5xl mx-auto text-center space-y-8"></div>


    <!-- 6. ìµœì¢… ê²°ê³¼ í™”ë©´ (ë‹¨ìˆœí™”) -->
    <div id="screen-final-results" class="hidden w-full max-w-5xl mx-auto text-center"></div>


    <!-- 7. ê¸°ë¡ ëª¨ë‹¬ íŒì—… -->
    <div id="record-event-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="card rounded-2xl w-full max-w-lg text-center space-y-6">
            <h3 id="record-event-title" class="text-6xl font-black"></h3>
            <div class="grid grid-cols-2 gap-4">
                <button data-action="record-event" data-stat="goal" class="btn bg-green-600 text-3xl">ë“ì </button>
                <button data-action="record-event" data-stat="ownGoal" class="btn bg-red-600 text-3xl">ìì±…ê³¨</button> <!-- ìì±…ê³¨ ë²„íŠ¼ ì¶”ê°€ -->
                <button data-action="record-event" data-stat="defense" class="btn bg-yellow-500 text-3xl text-gray-900">ìˆ˜ë¹„</button>
                <button data-action="record-event" data-stat="save" class="btn bg-purple-600 text-3xl">ì„ ë°©</button>
            </div>
            <button data-action="close-modal" class="btn btn-secondary w-full text-3xl">ì·¨ì†Œ</button>
        </div>
    </div>


    <!-- [ì‹ ê·œ] ë„ì›€ ì„ íƒ ëª¨ë‹¬ íŒì—… -->
    <div id="assist-select-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="card rounded-2xl w-full max-w-xl text-center space-y-6">
            <h3 class="text-6xl font-black mb-4"><span id="assist-scorer-name"></span> ì„ ìˆ˜ì˜ ë“ì !</h3>
            <p class="text-4xl text-gray-400 mb-4">ë„ì›€ì„ ì¤€ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            <div id="assist-player-list" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-60 overflow-y-auto p-2">
                <!-- ë„ì›€ ê°€ëŠ¥í•œ ì„ ìˆ˜ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button data-action="close-assist-modal" class="btn btn-secondary w-full text-3xl">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>


    <!-- [ì‹ ê·œ] í‚¤í¼ ì§€ì • ëª¨ë‹¬ íŒì—… -->
    <div id="goalkeeper-select-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="card rounded-2xl w-full max-w-xl text-center space-y-6">
            <h3 class="text-5xl font-black mb-4"><span id="gk-team-name"></span> íŒ€ í‚¤í¼ ì§€ì •</h3>
            <p class="text-2xl text-gray-400 mb-4">í‚¤í¼ë¡œ ì§€ì •í•  ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            <div id="gk-player-list" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-60 overflow-y-auto p-2">
                <!-- í‚¤í¼ ì„ íƒ ê°€ëŠ¥í•œ ì„ ìˆ˜ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button data-action="close-gk-modal" class="btn btn-secondary w-full text-3xl">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>


    <!-- [ì‹ ê·œ] ì„ ìˆ˜ êµì²´ ëª¨ë‹¬ íŒì—… -->
    <div id="player-swap-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="card rounded-2xl w-full max-w-xl text-center space-y-6">
            <h3 class="text-5xl font-black mb-4">ì„ ìˆ˜ êµì²´</h3>
            <div id="swap-out-player-info" class="mb-4 text-5xl font-bold text-gray-100"></div>
            <p class="text-2xl text-gray-400 mb-4">êµì²´ íˆ¬ì…í•  ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            <div id="swap-in-player-list" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-60 overflow-y-auto p-2">
                <!-- êµì²´ ê°€ëŠ¥í•œ ì„ ìˆ˜ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button data-action="close-swap-modal" class="btn btn-secondary w-full text-3xl">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>


    <!-- [ì‹ ê·œ] ë‹¤ìŒ ê²½ê¸° íŒ€ ì„ íƒ ëª¨ë‹¬ (ë¬´ìŠ¹ë¶€ ì‹œ) -->
    <div id="select-next-team-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="card rounded-2xl w-full max-w-lg text-center space-y-6">
            <h3 class="text-5xl font-black mb-4">ë¬´ìŠ¹ë¶€! ë‹¤ìŒ ê²½ê¸°ëŠ”?</h3>
            <p class="text-2xl text-gray-400 mb-4">ë‹¤ìŒ ê²½ê¸°ë¥¼ ì§„í–‰í•  íŒ€ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            <div id="next-team-options" class="grid grid-cols-2 gap-4">
                <!-- íŒ€ ì„ íƒ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
            </div>
        </div>
    </div>


    <!-- [ì‹ ê·œ] 3ê²½ê¸° ì—°ì† ê²½ê¸° í™•ì¸ ëª¨ë‹¬ -->
    <div id="confirm-next-match-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="card rounded-2xl w-full max-w-lg text-center space-y-6">
            <h3 class="text-5xl font-black mb-4"><span id="consecutive-team-name"></span> íŒ€ 3ê²½ê¸° ì—°ì† ê²½ê¸°!</h3>
            <p id="consecutive-match-suggestion" class="text-2xl text-gray-400 mb-4"></p>
            <div class="grid grid-cols-2 gap-4">
                <button data-action="confirm-next-match" data-confirm="true" class="btn btn-primary text-3xl">ì˜ˆ</button>
                <button data-action="confirm-next-match" data-confirm="false" class="btn btn-secondary text-3xl">ì•„ë‹ˆì˜¤ (ê²½ê¸° ì„ íƒ í™”ë©´ìœ¼ë¡œ)</button>
            </div>
        </div>
    </div>


    <!-- [ì‹ ê·œ] ì „ì²´ ì„¸ì…˜ ì¢…ë£Œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="confirm-session-end-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="card rounded-2xl w-full max-w-lg text-center space-y-6">
            <h3 class="text-5xl font-black mb-4">ì„¸ì…˜ ì¢…ë£Œ í™•ì¸</h3>
            <p id="confirm-session-end-modal-text" class="text-2xl text-gray-400 mb-4"></p>
            <div class="grid grid-cols-2 gap-4">
                <button data-action="confirm-session-end" data-confirm="true" class="btn btn-primary text-3xl">ì˜ˆ</button>
                <button data-action="confirm-session-end" data-confirm="false" class="btn btn-secondary text-3xl">ì•„ë‹ˆì˜¤</button>
            </div>
        </div>
    </div>


<script>
    let MASTER_PLAYERS_DB = [], localState = {}, timerInterval = null, currentEventData = {};
    let currentGoalkeeperSelectTeam = null;
    let currentPlayerToSwapOut = null;
    const teamColorClasses = { RED: 'text-red-500', BLUE: 'text-blue-500', YELLOW: 'text-yellow-500' };


    // --- ì„œë²„ í˜¸ì¶œ ---
    function serverCall(funcName, ...args) {
        if (typeof google === 'undefined' || typeof google.script === 'undefined' || typeof google.script.run === 'undefined') {
            console.error("ì˜¤ë¥˜: google.script.runì´ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            alert("ì˜¤ë¥˜: ì•±ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            document.getElementById('loading-overlay').style.display = 'none';
            return Promise.reject(new Error("Google Apps Script í™˜ê²½ì´ ì•„ë‹™ë‹ˆë‹¤."));
        }


        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }


        document.getElementById('loading-overlay').style.display = 'flex';
        console.log(`[Server Call] -> ${funcName}`, args);


        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(response => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    console.log(`[Server Response] <- ${funcName}`, response);


                    if (response.success) {
                        if (response.data && response.data.currentScreen) {
                            localState = response.data;
                            renderUI();
                        }
                        if (response.data && response.data.match && response.data.match.nextMatchSuggestion) {
                            const suggestion = response.data.match.nextMatchSuggestion;
                            if (suggestion.type === 'draw') {
                                openSelectNextTeamModal(suggestion.drawingTeams, suggestion.waitingTeam);
                            } else if (suggestion.type === 'consecutive') {
                                openConfirmNextMatchModal(suggestion.team, suggestion.suggestedTeams);
                            }
                        }
                        resolve(response.data);
                    } else {
                        alert(`ì„œë²„ ì˜¤ë¥˜: ${response.message}`);
                        reject(new Error(response.message));
                    }
                })
                .withFailureHandler(error => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    alert(`í†µì‹  ì˜¤ë¥˜: ${error.message}`);
                    reject(error);
                })
                [funcName](...args);
        });
    }


    // --- íƒ€ì´ë¨¸ ë¡œì§ ---
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        serverCall('toggleTimerState', true);
       
        let seconds = localState.match.seconds;
        timerInterval = setInterval(() => {
            seconds--;
            if (seconds < 0) seconds = 0;
            localState.match.seconds = seconds;
            updateTimerDisplay(seconds);


            if (seconds <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                alert('ì‹œê°„ ì¢…ë£Œ! "í˜„ì¬ ê²½ê¸° ì¢…ë£Œ" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
            }
        }, 1000);
    }


    function pauseTimer() {
        clearInterval(timerInterval);
        timerInterval = null;
        serverCall('toggleTimerState', false, localState.match.seconds);
    }


    function updateTimerDisplay(seconds) {
        const display = document.getElementById('timer-display');
        if (!display) return;
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        display.textContent = `${mins}:${secs}`;
    }


    // --- UI ë Œë”ë§ ---
    function renderUI() {
        const { currentScreen } = localState;
        document.querySelectorAll('body > div[id^="screen-"]').forEach(s => s.classList.add('hidden'));
        document.getElementById(currentScreen).classList.remove('hidden');


        const backBtn = document.getElementById('btn-back');
        const showBackBtn = currentScreen !== 'screen-attendance' && currentScreen !== 'screen-final-results';
        backBtn.classList.toggle('hidden', !showBackBtn);
        if(showBackBtn) {
            const screenFlow = {
                'screen-team-allocation': 'screen-attendance',
                'screen-match-select': localState.match.count > 1 ? 'screen-match-controller' : 'screen-team-allocation',
                'screen-match-controller': 'screen-match-select',
                'screen-session-summary': 'screen-match-controller'
            };
            backBtn.dataset.targetScreen = screenFlow[currentScreen];
        }
       
        const renderMap = {
            'screen-attendance': renderAttendanceScreen,
            'screen-team-allocation': renderAllocationScreen,
            'screen-match-select': renderMatchSelectScreen,
            'screen-match-controller': renderMatchControllerScreen,
            'screen-session-summary': renderSessionSummaryScreen,
            'screen-final-results': renderFinalResultsScreen
        };
        if (renderMap[currentScreen]) renderMap[currentScreen]();
    }


    function renderAttendanceScreen() {
        const gameDateInput = document.getElementById('game-date');
        if (gameDateInput) {
            gameDateInput.value = localState.selectedDate;
        }
        const listEl = document.getElementById('master-player-list');
        listEl.innerHTML = MASTER_PLAYERS_DB.map(p => `
            <div data-action="toggle-attendance" data-player-name="${p.name}" class="player-card card flex flex-col justify-center items-center p-4 text-center cursor-pointer ${localState.attendingPlayerNames.includes(p.name) ? 'selected' : ''}">
                <span class="font-black text-4xl">${p.name}</span>
                <span class="text-xl mt-1 text-gray-400">${p.position}</span>
            </div>
        `).join('');
        document.getElementById('attendance-count').textContent = localState.attendingPlayerNames.length;
    }


    function renderAllocationScreen() {
    const container = document.getElementById('team-allocation-container');
    if (!container) return;
    const playerStats = MASTER_PLAYERS_DB.reduce((acc, p) => { acc[p.name] = p; return acc; }, {});
    container.innerHTML = Object.keys(localState.teams).map(teamName => {
        const teamData = localState.teams[teamName];
        let players = teamData.players;
        const goalkeeper = teamData.goalkeeper;


        if (teamData.viceCaptain && !players.includes(teamData.viceCaptain)) {
            teamData.viceCaptain = null;
        }
        if (!teamData.viceCaptain && players.length >= 2 && teamData.captain) {
            const candidates = players.filter(p => p !== teamData.captain);
            if (candidates.length > 0) {
                teamData.viceCaptain = candidates[Math.floor(Math.random() * candidates.length)];
            }
        }


        if (players.length === 0 && !goalkeeper) return '';


        let teamTotalAttack = 0;
        let teamTotalDefense = 0;
        const allTeamPlayers = [...players, goalkeeper].filter(Boolean);
        allTeamPlayers.forEach(pName => {
            const pData = playerStats[pName];
            if (pData) {
                teamTotalAttack += (pData.att || 0);
                teamTotalDefense += (pData.def || 0);
            }
        });


        const teamTotalPlayers = new Set(allTeamPlayers).size;
        const teamAvgAttack = teamTotalPlayers > 0 ? (teamTotalAttack / teamTotalPlayers).toFixed(1) : 0;
        const teamAvgDefense = teamTotalPlayers > 0 ? (teamTotalDefense / teamTotalPlayers).toFixed(1) : 0;


        return `
            <div class="card space-y-4 w-full">
                <h3 class="text-5xl font-black ${teamColorClasses[teamName]}">${teamName} <span class="text-2xl text-gray-400 ml-2">(ì´ì›: ${teamTotalPlayers}ëª… | ATT: ${teamAvgAttack} | DEF: ${teamAvgDefense})</span></h3>
                <div class="grid grid-cols-2 gap-2">
                    ${players.map(p => {
                        const isCaptain = p === teamData.captain;
                        const isViceCaptain = p === teamData.viceCaptain;
                        let armbandHTML = '';
                        if (isCaptain) {
                            armbandHTML = '<span class="armband captain-armband">C</span>';
                        } else if (isViceCaptain) {
                            armbandHTML = '<span class="armband vice-captain-armband">VC</span>';
                        }
                       
                        return `
                            <button data-action="open-swap-modal" data-player-name="${p}" data-team-name="${teamName}" class="btn bg-gray-700 text-gray-100 w-full text-3xl p-4">
                                <div class="flex justify-between items-center w-full">
                                    <span>${p}</span>
                                    ${armbandHTML}
                                </div>
                            </button>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }).join('');
}


    function renderMatchSelectScreen() {
        const matchDurationSelect = document.getElementById('match-duration');
        if (matchDurationSelect) {
            matchDurationSelect.value = localState.match.selectedDuration;
        }
        const fieldSelect = document.getElementById('field-select');
        if (fieldSelect) {
            fieldSelect.value = localState.selectedField;
        }
        const container = document.getElementById('team-select-container');
        container.innerHTML = Object.keys(localState.teams)
            .filter(t => localState.teams[t].players.length > 0 || localState.teams[t].goalkeeper)
            .map(teamName => {
                const isSelected = localState.match.playingTeams.includes(teamName) ? 'selected' : '';
                const teamStat = localState.sessionStats.teamStats[teamName] || { wins: 0, draws: 0, losses: 0 };
                return `
                    <div data-action="toggle-team-select" data-team-name="${teamName}" class="team-card card rounded-2xl cursor-pointer border-4 border-gray-700 w-full mb-6 ${isSelected}">
                        <h2 class="text-6xl font-black ${teamColorClasses[teamName]}">${teamName}</h2>
                        <p class="text-2xl text-gray-400 mt-2">(${teamStat.wins}ìŠ¹ ${teamStat.draws}ë¬´ ${teamStat.losses}íŒ¨)</p>
                    </div>
                `;
            }).join('');


        const startMatchBtn = document.getElementById('btn-start-match');
        const selectedTeamsCount = localState.match.playingTeams.length;
        if (selectedTeamsCount === 2) {
            startMatchBtn.disabled = false;
            startMatchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            startMatchBtn.disabled = true;
            startMatchBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }


    function renderMatchControllerScreen() {
        const { teamA, teamB, count, timeline, timerRunning, seconds, todayHeadToHead } = localState.match;
        const container = document.getElementById('screen-match-controller');
       
        const headToHeadKey = [teamA.name, teamB.name].sort().join('_');
        const h2hStats = todayHeadToHead[headToHeadKey] || { [teamA.name]: { wins: 0, draws: 0, losses: 0 }, [teamB.name]: { wins: 0, draws: 0, losses: 0 } };
        const teamA_h2h = h2hStats[teamA.name];
        const teamB_h2h = h2hStats[teamB.name];
        const h2hDisplay = `<span class="${teamColorClasses[teamA.name]}">${teamA.name}</span> ${teamA_h2h.wins}ìŠ¹ ${teamA_h2h.draws}ë¬´ ${teamA_h2h.losses}íŒ¨ <span class="mx-2 text-gray-400">vs</span> <span class="${teamColorClasses[teamB.name]}">${teamB.name}</span> ${teamB_h2h.wins}ìŠ¹ ${teamB_h2h.draws}ë¬´ ${teamB_h2h.losses}íŒ¨`;
        const teamA_matchesPlayed = localState.sessionStats.teamStats[teamA.name].matchesPlayed || 0;
        const teamB_matchesPlayed = localState.sessionStats.teamStats[teamB.name].matchesPlayed || 0;
        const matchesPlayedDisplay = `<span class="${teamColorClasses[teamA.name]}">${teamA.name}</span> ${teamA_matchesPlayed}ë²ˆì§¸ ê²½ê¸° <span class="mx-2 text-gray-400">vs</span> <span class="${teamColorClasses[teamB.name]}">${teamB.name}</span> ${teamB_matchesPlayed}ë²ˆì§¸ ê²½ê¸°`;


        container.innerHTML = `
            <div class="space-y-8">
                <div class="text-center">
                    <p class="text-3xl text-gray-400 font-bold">Match #${count}</p>
                    <p class="text-2xl text-gray-300 font-semibold mt-2">${h2hDisplay}</p>
                   
                    <div class="flex justify-center items-center text-7xl font-black my-4">
                        <span class="${teamColorClasses[teamA.name]}">${teamA.name}</span>
                        <span class="mx-8 text-gray-100">${teamA.score} : ${teamB.score}</span>
                        <span class="${teamColorClasses[teamB.name]}">${teamB.name}</span>
                    </div>
                </div>
                <div class="flex justify-center items-center gap-8">
                    <span id="timer-display" class="text-7xl font-mono card py-5 px-10 bg-gray-700 text-gray-100">${Math.floor(seconds / 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}</span>
                    <button data-action="toggle-timer" class="btn ${timerRunning ? 'btn-secondary' : 'btn-primary'} text-3xl px-10 w-48">${timerRunning ? 'ì¼ì‹œì •ì§€' : 'ì‹œì‘'}</button>
                </div>
               
                <div class="flex justify-center border-b border-gray-600 mb-6 gap-x-12">
                    <button class="tab-button active" data-tab="players">ë¼ì¸ì—…</button>
                    <button class="tab-button" data-tab="team-stats">íŒ€ ìˆœìœ„</button>
                    <button class="tab-button" data-tab="player-stats">ê°œì¸ê¸°ë¡ ìˆœìœ„</button>
                </div>


                <div id="tab-content-players" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${[teamA, teamB].map(team => `
                            <div class="card space-y-4">
                                <h3 class="text-5xl font-black ${teamColorClasses[team.name]}">${team.name} ë¼ì¸ì—…</h3>
                                <div class="flex flex-col gap-2">
                                    <button data-action="open-gk-modal" data-team-name="${team.name}" class="btn bg-purple-700 w-full text-left text-2xl font-bold">
                                        ê³¨í‚¤í¼: ${localState.teams[team.name].goalkeeper || 'ë¯¸ì§€ì •'}
                                    </button>
                                    ${localState.teams[team.name].players.map(p => `
                                        <div class="flex gap-2">
                                            <button data-action="open-record-modal" data-player-name="${p}" data-team-name="${team.name}" class="btn bg-gray-700 text-gray-100 flex-grow text-left text-4xl">
                                                ${p}
                                            </button>
                                            <button data-action="open-swap-modal" data-player-name="${p}" data-team-name="${team.name}" class="btn btn-secondary text-4xl px-4">ğŸ”„</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div id="tab-content-team-stats" class="tab-content">
    ${renderTeamRankingsTable()}
</div>
                </div>


                <div id="tab-content-player-stats" class="tab-content">
                    ${renderPlayerStatsRankings()}
                </div>


                <div class="grid grid-cols-2 gap-4">
                    <button data-action="undo" class="btn btn-secondary text-4xl">ìŠ¤íƒ¯ ì·¨ì†Œ</button>
                    <button data-action="end-match" class="btn btn-primary text-4xl">í˜„ì¬ ê²½ê¸° ì¢…ë£Œ</button>
                </div>
               
                <button data-action="finish-session-to-summary" class="btn btn-danger w-full bg-red-800 text-4xl">ğŸš¨ ì „ì²´ ì„¸ì…˜ ì¢…ë£Œ</button>
               
                <div class="card max-h-60 overflow-y-auto">
                    <h3 class="text-3xl font-bold mb-4">íƒ€ì„ë¼ì¸</h3>
                    <ul class="text-xl space-y-2 text-left">${timeline.map(e => `<li class="border-b border-gray-700 pb-2 text-gray-300">[${e.time}] <span class="${teamColorClasses[e.teamName]} font-bold">${e.player}</span>: ${e.stat === 'goal' ? 'ë“ì ' + (e.assistPlayer ? ` (ë„ì›€: ${e.assistPlayer})` : '') : e.stat === 'assist' ? 'ë„ì›€' : e.stat === 'defense' ? 'ìˆ˜ë¹„' : e.stat === 'save' ? 'ì„ ë°©' : 'ìì±…ê³¨'}</li>`).join('') || '<li class="text-gray-500">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>'}</ul>
                </div>
            </div>
        `;
        updateTimerDisplay(seconds);
        const toggleTimerBtn = document.querySelector('#screen-match-controller [data-action="toggle-timer"]');
        if (toggleTimerBtn) {
            if (timerRunning) {
                toggleTimerBtn.textContent = 'ì¼ì‹œì •ì§€';
                toggleTimerBtn.classList.remove('btn-primary');
                toggleTimerBtn.classList.add('btn-secondary');
            } else {
                toggleTimerBtn.textContent = 'ì‹œì‘';
                toggleTimerBtn.classList.remove('btn-secondary');
                toggleTimerBtn.classList.add('btn-primary');
            }
        }
        if (timerRunning && !timerInterval) startTimer();


        document.querySelectorAll('.tab-button').forEach(button => {
            button.removeEventListener('click', handleTabClick);
            button.addEventListener('click', handleTabClick);
        });
    }


    function handleTabClick(event) {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`tab-content-${event.target.dataset.tab}`).classList.add('active');
    }


    function renderPlayerStatsRankings() {
        const playerStats = localState.sessionStats.playerStats;
        const playersArray = Object.keys(playerStats).map(name => ({ name, ...playerStats[name] }));


        const mvpRank = [...playersArray].sort((a, b) => {
            const scoreA = (a.goal * 3) + (a.assist * 3) + (a.defense * 1) + (a.save * 1);
            const scoreB = (b.goal * 3) + (b.assist * 3) + (b.defense * 1) + (b.save * 1);
            return scoreB - scoreA;
        }).filter(p => ((p.goal || 0) * 3) + ((p.assist || 0) * 3) + ((p.defense || 0) * 1) + ((p.save || 0) * 1) > 0).slice(0, 3);


        const goalRank = [...playersArray].sort((a, b) => b.goal - a.goal).filter(p => p.goal > 0).slice(0, 5);
        const assistRank = [...playersArray].sort((a, b) => b.assist - a.assist).filter(p => p.assist > 0).slice(0, 5);
        const defenseRank = [...playersArray].sort((a, b) => (b.defense + b.save) - (a.defense + a.save)).filter(p => (p.defense + p.save) > 0).slice(0, 5);
        const saveRank = [...playersArray].sort((a, b) => b.save - a.save).filter(p => p.save > 0).slice(0, 5);


        const renderRankingList = (title, rankList, statKey, secondaryStatKey = null) => {
            if (rankList.length === 0) return '';
            return `
                <div class="card mb-6">
                    <h4 class="text-3xl font-bold mb-3 text-gray-100">${title}</h4>
                    <ul class="space-y-3">
                        ${rankList.map((p, index) => `
                            <li class="flex justify-between items-center text-2xl border-b border-gray-700 pb-3 text-gray-300">
                                <span>${index + 1}. ${p.name}</span>
                                <span>${p[statKey]}${secondaryStatKey ? ` (${p[secondaryStatKey]})` : ''}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        };
       
        const mvpRankHtml = mvpRank.length > 0 ? `
            <div class="card mb-6 bg-yellow-900 text-yellow-100">
                <h4 class="text-3xl font-bold mb-3">ğŸ† MVP ìˆœìœ„</h4>
                <ul class="space-y-3">
                    ${mvpRank.map((p, index) => `
                        <li class="flex justify-between items-center text-2xl border-b border-yellow-700 pb-3">
                            <span>${index + 1}. ${p.name}</span>
                            <span>MP ${((p.goal || 0) * 3) + ((p.assist || 0) * 3) + ((p.defense || 0) * 1) + ((p.save || 0) * 1)}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>
        ` : '';


        return `
            <div class="space-y-6">
                ${mvpRankHtml}
                ${renderRankingList('ë“ì  ìˆœìœ„', goalRank, 'goal')}
                ${renderRankingList('ë„ì›€ ìˆœìœ„', assistRank, 'assist')}
                ${renderRankingList('ìˆ˜ë¹„ ìˆœìœ„', defenseRank, 'defense', 'save')}
                ${renderRankingList('ì„ ë°© ìˆœìœ„', saveRank, 'save')}
            </div>
        `;
    }




// [ì§„ì§œ ìµœì¢… ìˆ˜ì •ë³¸] ì˜¤ëŠ˜ì˜ ê²½ê¸° ê²°ê³¼ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜
function renderSessionSummaryScreen() {
    const container = document.getElementById('screen-session-summary');
    const { sessionResults, sessionStats } = localState;
    const playerStats = sessionStats.playerStats;
    const teamStats = sessionStats.teamStats;


    // --- 1. ì˜¤ëŠ˜ì˜ ìˆ˜ìƒì ì •ë³´ (ìƒ‰ìƒ í†µì¼) ---
    let topScorer = null, maxGoals = -1;
    Object.keys(playerStats).forEach(pName => {
        if (playerStats[pName].goal > maxGoals) {
            maxGoals = playerStats[pName].goal;
            topScorer = pName;
        }
    });
    let topAssist = null, maxAssists = -1;
    Object.keys(playerStats).forEach(pName => {
        if (playerStats[pName].assist > maxAssists) {
            maxAssists = playerStats[pName].assist;
            topAssist = pName;
        }
    });


    const awardsHtml = `
        <div class="card mb-8">
            <h2 class="text-4xl font-bold mb-4 text-gray-100">ì˜¤ëŠ˜ì˜ ìˆ˜ìƒì</h2>
            ${sessionResults?.mvp ? `<p class="text-3xl font-bold text-yellow-500">ğŸ† MVP: ${sessionResults.mvp} (${playerStats[sessionResults.mvp]?.goal}ë“ì  ${playerStats[sessionResults.mvp]?.assist}ë„ì›€)</p>` : ''}
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                ${topScorer && maxGoals > 0 ? `<p class="text-2xl font-bold text-yellow-500">âš½ ìµœë‹¤ë“ì : ${topScorer} (${maxGoals}ë“ì )</p>` : ''}
                ${topAssist && maxAssists > 0 ? `<p class="text-2xl font-bold text-yellow-500">ğŸ‘Ÿ ìµœë‹¤ë„ì›€: ${topAssist} (${maxAssists}ë„ì›€)</p>` : ''}
                ${sessionResults?.bestDefender ? `<p class="text-2xl font-bold text-yellow-500">ğŸ›¡ï¸ ì˜¤ëŠ˜ì˜ ìˆ˜ë¹„ìˆ˜: ${sessionResults.bestDefender} (${playerStats[sessionResults.bestDefender]?.defense}ìˆ˜ë¹„)</p>` : ''}
                ${sessionResults?.bestGoalkeeper ? `<p class="text-2xl font-bold text-yellow-500">ğŸ§¤ ì˜¤ëŠ˜ì˜ ê³¨í‚¤í¼: ${sessionResults.bestGoalkeeper} (${playerStats[sessionResults.bestGoalkeeper]?.save}ì„ ë°©)</p>` : ''}
            </div>
        </div>
    `;


    // --- 2. íŒ€ ìˆœìœ„ í‘œ ìƒì„± (íŠ¸ë¡œí”¼ ìœ„ì¹˜ ì´ë™) ---
    const teamsArray = Object.keys(teamStats)
        .filter(teamName => teamStats[teamName].matchesPlayed > 0)
        .map(teamName => {
            const stats = teamStats[teamName];
            const points = (stats.wins * 3) + (stats.draws * 1);
            const goalDifference = stats.goalsFor - stats.goalsAgainst;
            const winRate = (stats.wins + stats.losses) > 0 ? ((stats.wins / (stats.wins + stats.losses)) * 100).toFixed(1) + '%' : '-';
            return { name: teamName, played: stats.matchesPlayed, wins: stats.wins, draws: stats.draws, losses: stats.losses, gf: stats.goalsFor, ga: stats.goalsAgainst, gd: goalDifference, points: points, winRate: winRate };
        })
        .sort((a, b) => {
            if (b.points !== a.points) return b.points - a.points;
            if (b.gd !== a.gd) return b.gd - a.gd;
            return b.gf - a.gf;
        });


    const teamRankingsHtml = `
        <div class="card mb-8 overflow-x-auto">
            <h2 class="text-4xl font-bold mb-4 text-gray-100">ì˜¤ëŠ˜ì˜ íŒ€ ìˆœìœ„</h2>
            <table class="w-full text-5xl edit-table">
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th><th>íŒ€</th><th>ê²½ê¸°ìˆ˜</th><th>ìŠ¹</th><th>ë¬´</th><th>íŒ¨</th><th>ë“ì </th><th>ì‹¤ì </th><th>ë“ì‹¤ì°¨</th><th>ìŠ¹ë¥ </th><th>ìŠ¹ì </th>
                    </tr>
                </thead>
                <tbody>
                    ${teamsArray.map((t, index) => `
                        <tr>
                            <td class="font-bold">${index + 1}</td>
                            <td class="font-bold ${teamColorClasses[t.name]}">${t.name} ${index === 0 ? '<span>ğŸ†</span>' : ''}</td>
                            <td>${t.played}</td>
                            <td>${t.wins}</td>
                            <td>${t.draws}</td>
                            <td>${t.losses}</td>
                            <td>${t.gf}</td>
                            <td>${t.ga}</td>
                            <td>${t.gd > 0 ? `+${t.gd}` : t.gd}</td>
                            <td>${t.winRate}</td>
                            <td class="font-bold text-blue-400">${t.points}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;


    // --- 3. íŒ€ë³„ ê°œì¸ ìŠ¤íƒ¯ (í‘œ ê°„ì†Œí™” ë° í°íŠ¸ í¬ê¸° ì¡°ì •) ---
    const teamStatsHtml = `
        <div class="card mb-8 overflow-x-auto">
            <h2 class="text-4xl font-bold mb-4 text-gray-100">íŒ€ë³„ ê°œì¸ ìŠ¤íƒ¯</h2>
            ${Object.keys(localState.teams).map(teamName => {
                const teamData = localState.teams[teamName];
                const playersInTeam = [...new Set([...teamData.players, teamData.goalkeeper].filter(Boolean))];
                if (playersInTeam.length === 0) return '';
                return `
                    <div class="mb-6">
                        <h3 class="text-3xl font-black ${teamColorClasses[teamName]} text-left mb-3">${teamName} íŒ€</h3>
                        <table class="w-full text-5xl edit-table">
                            <thead>
                                <tr>
                                    <th>ì„ ìˆ˜ëª…</th><th>ë“ì </th><th>ë„ì›€</th><th>ìˆ˜ë¹„</th><th>ì„ ë°©</th><th>MP</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${playersInTeam.map(pName => {
                                    const stats = playerStats[pName] || {goal:0, assist:0, defense:0, save:0};
                                    const mp = ((stats.goal || 0) * 3) + ((stats.assist || 0) * 3) + ((stats.defense || 0) * 1) + ((stats.save || 0) * 1);
                                    return `
                                        <tr>
                                            <td class="font-bold text-gray-100">${pName}</td>
                                            <td>${stats.goal}</td>
                                            <td>${stats.assist}</td>
                                            <td>${stats.defense}</td>
                                            <td>${stats.save}</td>
                                            <td class="font-bold text-blue-400">${mp}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }).join('')}
        </div>
    `;


    // ìµœì¢… í™”ë©´ êµ¬ì„± (ìˆœì„œ ë³€ê²½)
    container.innerHTML = `
        <h1 class="text-6xl font-black mb-8 text-gray-100">ì˜¤ëŠ˜ì˜ ê²½ê¸° ê²°ê³¼</h1>
        ${awardsHtml}
        ${teamRankingsHtml}
        ${teamStatsHtml}
        <div class="flex flex-col sm:flex-row gap-4 mt-8">
            <button data-action="save-and-start-new-session" class="btn btn-primary w-full text-2xl">ê¸°ë¡ ì €ì¥ ë° ìƒˆ ì„¸ì…˜ ì‹œì‘</button>
            <button data-action="discard-and-start-new-session" class="btn btn-secondary w-full text-2xl">ê¸°ë¡ ë²„ë¦¬ê³  ìƒˆ ì„¸ì…˜ ì‹œì‘</button>
        </div>
    `;
}




    function renderFinalResultsScreen() {
        document.getElementById('screen-final-results').innerHTML = `
            <div class="space-y-8">
                <h1 class="text-6xl font-black text-gray-100">ì„¸ì…˜ ì¢…ë£Œ</h1>
                <p class="mt-4 text-2xl text-gray-400">ì˜¤ëŠ˜ì˜ ëª¨ë“  ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!</p>
                <button data-action="reset" class="btn btn-primary mt-8 text-2xl">ìƒˆ ì„¸ì…˜ ì‹œì‘</button>
            </div>
        `;
    }


    // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const data = await serverCall('getInitialData');
            MASTER_PLAYERS_DB = data.masterPlayers;
            localState = data.appState;
            renderUI();
        } catch (e) {
            console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
            alert('ì•±ì„ ì´ˆê¸°í™”í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        }
    });


    document.body.addEventListener('click', async (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;


        // â˜…â˜…â˜…â˜…â˜… ë¬¸ì œì˜ ì›ì¸ ìˆ˜ì • â˜…â˜…â˜…â˜…â˜…
        // 'confirm'ì€ window.confirm() í•¨ìˆ˜ ì´ë¦„ê³¼ ê²¹ì¹˜ë¯€ë¡œ ë³€ìˆ˜ëª…ì„ isConfirmedë¡œ ë³€ê²½
        const { action, playerName, teamName, stat, targetScreen, assistPlayerName, gkPlayerName, swapOutPlayerName, swapInPlayerName, confirm: isConfirmed } = target.dataset;


        switch (action) {
            case 'go-back':
                serverCall('changeScreen', targetScreen);
                break;
            case 'toggle-attendance':
                const names = localState.attendingPlayerNames;
                const index = names.indexOf(playerName);
                if (index > -1) names.splice(index, 1);
                else names.push(playerName);
                renderAttendanceScreen();
                break;
            case 'go-to-allocation':
                if (localState.attendingPlayerNames.length < 2) return alert('ìµœì†Œ 2ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                (async () => {
                    try {
                        const selectedDate = document.getElementById('game-date').value;
                        await serverCall('setAttendingPlayersAndDate', localState.attendingPlayerNames, selectedDate);
                        await serverCall('performTeamAllocation', document.getElementById('assignment-strategy').value);
                    } catch (e) {
                        console.error('íŒ€ ë°°ë¶„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', e);
                        alert('íŒ€ ë°°ë¶„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                })();
                break;
            case 're-allocate':
                serverCall('performTeamAllocation', document.getElementById('assignment-strategy').value);
                break;
            case 'go-to-match-select':
                serverCall('changeScreen', 'screen-match-select');
                break;
            case 'toggle-team-select':
                const teamToToggle = teamName;
                const isCurrentlySelected = localState.match.playingTeams.includes(teamToToggle);
                let tempUpdatedPlayingTeams = [];
                if (isCurrentlySelected) {
                    tempUpdatedPlayingTeams = localState.match.playingTeams.filter(t => t !== teamToToggle);
                } else {
                    tempUpdatedPlayingTeams = [...localState.match.playingTeams, teamToToggle];
                }
                if (tempUpdatedPlayingTeams.length > 2) {
                    alert('ê²½ê¸°ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ì •í™•íˆ ë‘ íŒ€ë§Œ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }
                localState.match.playingTeams = tempUpdatedPlayingTeams;
                renderUI();
                break;
            case 'start-selected-match':
                const selectedTeamsToStart = localState.match.playingTeams;
                if (selectedTeamsToStart.length !== 2) {
                    alert('ê²½ê¸°ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ì •í™•íˆ ë‘ íŒ€ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }
                const selectedDuration = parseInt(document.getElementById('match-duration').value);
                const selectedField = document.getElementById('field-select').value;
                serverCall('startMatch', selectedTeamsToStart, selectedDuration, selectedField);
                break;
            case 'open-record-modal':
                if (!localState.match.timerRunning && localState.match.seconds > 0) {
                    alert('ê²½ê¸°ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì¼ì‹œì •ì§€ ìƒíƒœì—ì„œëŠ” ê¸°ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.');
                    return;
                }
                currentEventData = { player: playerName, teamName: teamName };
                document.getElementById('record-event-title').textContent = `${playerName} (${teamName})`;
                document.getElementById('record-event-modal').classList.remove('hidden');
                break;
            case 'close-modal':
                target.closest('.fixed').classList.add('hidden');
                break;
            case 'record-event':
                const recordStat = stat;
                if (recordStat === 'goal') {
                    document.getElementById('record-event-modal').classList.add('hidden');
                    document.getElementById('assist-scorer-name').textContent = currentEventData.player;
                    const assistPlayerListEl = document.getElementById('assist-player-list');
                    const currentTeamPlayers = localState.teams[currentEventData.teamName].players;
                    const scorer = currentEventData.player;
                    const assistOptions = currentTeamPlayers.filter(p => p !== scorer);
                    assistOptions.push("ì—†ìŒ");
                    assistPlayerListEl.innerHTML = assistOptions.map(p => `
                        <button data-action="select-assist-player" data-assist-player-name="${p}" class="btn bg-gray-700 text-gray-100 text-3xl w-full">${p}</button>
                    `).join('');
                    document.getElementById('assist-select-modal').classList.remove('hidden');
                } else {
                    // â–¼â–¼â–¼ í•µì‹¬ ìˆ˜ì •: í˜„ì¬ ë‚¨ì€ ì‹œê°„(localState.match.seconds)ì„ í•¨ê»˜ ë³´ëƒ…ë‹ˆë‹¤. â–¼â–¼â–¼
                    serverCall('recordEvent', { ...currentEventData, stat: recordStat }, localState.match.seconds);
                    target.closest('.fixed').classList.add('hidden');
                }
                break;
            case 'select-assist-player':
                const finalAssistPlayer = assistPlayerName === "ì—†ìŒ" ? null : assistPlayerName;
                // â–¼â–¼â–¼ í•µì‹¬ ìˆ˜ì •: í˜„ì¬ ë‚¨ì€ ì‹œê°„(localState.match.seconds)ì„ í•¨ê»˜ ë³´ëƒ…ë‹ˆë‹¤. â–¼â–¼â–¼
                serverCall('recordEvent', { ...currentEventData, stat: 'goal', assistPlayer: finalAssistPlayer }, localState.match.seconds);
                document.getElementById('assist-select-modal').classList.add('hidden');
                break;
            case 'close-assist-modal':
                document.getElementById('assist-select-modal').classList.add('hidden');
                break;
            case 'open-gk-modal':
                currentGoalkeeperSelectTeam = teamName;
                document.getElementById('gk-team-name').textContent = teamName;
                const gkPlayerListEl = document.getElementById('gk-player-list');
                const allTeamNames = ['RED', 'BLUE', 'YELLOW'];
                const availablePlayers = localState.attendingPlayerNames.filter(pName => {
                    return !allTeamNames.some(tName => localState.teams[tName].players.includes(pName) || localState.teams[tName].goalkeeper === pName);
                });
                const currentTeamFieldPlayers = localState.teams[teamName].players;
                let gkOptionsHtml = '';
                if (currentTeamFieldPlayers.length > 0) {
                    gkOptionsHtml += `<p class="text-2xl font-bold text-gray-400 col-span-full mt-4">ìš°ë¦¬ íŒ€ ì„ ìˆ˜:</p>`;
                    gkOptionsHtml += currentTeamFieldPlayers.map(p => `<button data-action="select-goalkeeper" data-gk-player-name="${p}" class="btn bg-gray-700 text-gray-100 text-2xl w-full">${p}</button>`).join('');
                }
                if (availablePlayers.length > 0) {
                    gkOptionsHtml += `<p class="text-2xl font-bold text-gray-400 col-span-full mt-4">ëŒ€ê¸° ì„ ìˆ˜:</p>`;
                    gkOptionsHtml += availablePlayers.map(p => `<button data-action="select-goalkeeper" data-gk-player-name="${p}" class="btn bg-gray-700 text-gray-100 text-2xl w-full">${p}</button>`).join('');
                }
                gkOptionsHtml += `<p class="text-2xl font-bold text-gray-400 col-span-full mt-4">ê¸°íƒ€:</p><button data-action="select-goalkeeper" data-gk-player-name="null" class="btn bg-red-700 text-2xl w-full">í‚¤í¼ í•´ì œ</button>`;
                gkPlayerListEl.innerHTML = gkOptionsHtml;
                document.getElementById('goalkeeper-select-modal').classList.remove('hidden');
                break;
            case 'select-goalkeeper':
                const finalGkPlayer = gkPlayerName === "null" ? null : gkPlayerName;
                await serverCall('setGoalkeeper', currentGoalkeeperSelectTeam, finalGkPlayer);
                document.getElementById('goalkeeper-select-modal').classList.add('hidden');
                break;
            case 'close-gk-modal':
                document.getElementById('goalkeeper-select-modal').classList.add('hidden');
                break;
            case 'open-swap-modal':
                currentPlayerToSwapOut = { player: playerName, team: teamName, isGoalkeeper: localState.teams[teamName].goalkeeper === playerName };
                document.getElementById('swap-out-player-info').textContent = `${playerName} (${teamName}) ${currentPlayerToSwapOut.isGoalkeeper ? 'GK' : ''} â¡ï¸`;
                const swapInPlayerListEl = document.getElementById('swap-in-player-list');
                let swapOptionsHtml = '';
                const allTeamNamesForSwap = ['RED', 'BLUE', 'YELLOW'];
                allTeamNamesForSwap.forEach(otherTeamName => {
                    if (otherTeamName !== teamName) {
                        const playersAndGk = [...localState.teams[otherTeamName].players, localState.teams[otherTeamName].goalkeeper].filter(Boolean);
                        if (playersAndGk.length > 0) {
                            swapOptionsHtml += `<p class="text-2xl font-bold ${teamColorClasses[otherTeamName]} col-span-full mt-4">${otherTeamName} íŒ€ ì„ ìˆ˜:</p>`;
                            swapOptionsHtml += playersAndGk.map(p => `<button data-action="select-swap-player" data-swap-in-player-name="${p}" class="btn bg-gray-700 text-gray-100 text-4xl w-full">${p}</button>`).join('');
                        }
                    }
                });
                const waitingPlayersForSwap = localState.attendingPlayerNames.filter(pName => !allTeamNamesForSwap.some(tName => localState.teams[tName].players.includes(pName) || localState.teams[tName].goalkeeper === pName));
                if (waitingPlayersForSwap.length > 0) {
                    swapOptionsHtml += `<p class="text-2xl font-bold text-gray-400 col-span-full mt-4">ëŒ€ê¸° ì„ ìˆ˜:</p>`;
                    swapOptionsHtml += waitingPlayersForSwap.map(p => `<button data-action="select-swap-player" data-swap-in-player-name="${p}" class="btn bg-gray-700 text-gray-100 text-4xl w-full">${p}</button>`).join('');
                }
                if (!currentPlayerToSwapOut.isGoalkeeper) {
                    swapOptionsHtml += `<p class="text-2xl font-bold text-gray-400 col-span-full mt-4">ê¸°íƒ€:</p><button data-action="select-swap-player" data-swap-in-player-name="null" class="btn bg-red-700 text-2xl w-full">ì„ ìˆ˜ ì œê±°</button>`;
                }
                swapInPlayerListEl.innerHTML = swapOptionsHtml;
                document.getElementById('player-swap-modal').classList.remove('hidden');
                break;
            case 'select-swap-player':
                const finalSwapInPlayer = swapInPlayerName === "null" ? null : swapInPlayerName;
                if (currentPlayerToSwapOut) {
                    await serverCall('substitutePlayer', currentPlayerToSwapOut.team, currentPlayerToSwapOut.player, finalSwapInPlayer);
                }
                document.getElementById('player-swap-modal').classList.add('hidden');
                break;
            case 'close-swap-modal':
                document.getElementById('player-swap-modal').classList.add('hidden');
                break;
            case 'toggle-timer':
                if (localState.match.timerRunning) pauseTimer();
                else startTimer();
                break;
            case 'undo':
                if (window.confirm('ë§ˆì§€ë§‰ ê¸°ë¡ì„ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) serverCall('undoLastEvent');
                break;
            case 'end-match':
                if (window.confirm('í˜„ì¬ ê²½ê¸°ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) serverCall('endMatch');
                break;
            case 'finish-session-to-summary':
                document.getElementById('confirm-session-end-modal-text').textContent = 'ì˜¤ëŠ˜ì˜ ëª¨ë“  ê²½ê¸°ë¥¼ ëë‚´ê³  ê¸°ë¡ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                document.getElementById('confirm-session-end-modal').classList.remove('hidden');
                break;
            case 'confirm-session-end':
                document.getElementById('confirm-session-end-modal').classList.add('hidden');
                if (isConfirmed === 'true') {
                    serverCall('finishSessionToSummary');
                }
                break;
            case 'save-and-start-new-session':
    if (window.confirm('ìˆ˜ì •ëœ ê¸°ë¡ì„ ì €ì¥í•˜ê³  ìƒˆ ì„¸ì…˜ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        serverCall('updateAndArchiveSession');
    }
    break;
            case 'discard-and-start-new-session':
                if (window.confirm('í˜„ì¬ ì„¸ì…˜ ê¸°ë¡ì„ ì €ì¥í•˜ì§€ ì•Šê³  ìƒˆ ì„¸ì…˜ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) serverCall('resetSession');
                break;
            case 'reset':
                if (window.confirm('ëª¨ë“  ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ê³  ìƒˆ ì„¸ì…˜ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) serverCall('resetSession');
                break;
            case 'select-next-team':
                document.getElementById('select-next-team-modal').classList.add('hidden');
                await serverCall('selectNextPlayingTeam', teamName);
                break;
            case 'confirm-next-match':
                document.getElementById('confirm-next-match-modal').classList.add('hidden');
                await serverCall('confirmNextMatch', isConfirmed === 'true');
                break;
        }
    });


    // [ì‹ ê·œ] íŒ€ ìˆœìœ„ í‘œë¥¼ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ (ì„¸ì…˜ ìš”ì•½ í™”ë©´ì—ì„œ ë¶„ë¦¬)
function renderTeamRankingsTable() {
    const { teamStats } = localState.sessionStats;
    const teamsArray = Object.keys(teamStats)
        .filter(teamName => teamStats[teamName].matchesPlayed > 0)
        .map(teamName => {
            const stats = teamStats[teamName];
            const points = (stats.wins * 3) + (stats.draws * 1);
            const goalDifference = stats.goalsFor - stats.goalsAgainst;
            const winRate = (stats.wins + stats.losses) > 0 ? ((stats.wins / (stats.wins + stats.losses)) * 100).toFixed(1) + '%' : '-';
            return { name: teamName, played: stats.matchesPlayed, wins: stats.wins, draws: stats.draws, losses: stats.losses, gf: stats.goalsFor, ga: stats.goalsAgainst, gd: goalDifference, points: points, winRate: winRate };
        })
        .sort((a, b) => {
            if (b.points !== a.points) return b.points - a.points;
            if (b.gd !== a.gd) return b.gd - a.gd;
            return b.gf - a.gf;
        });


    const teamColorClasses = { RED: 'text-red-500', BLUE: 'text-blue-500', YELLOW: 'text-yellow-500' };


    const tableHtml = `
        <div class="card mb-8 overflow-x-auto">
            <h2 class="text-4xl font-bold mb-4 text-gray-100">ì˜¤ëŠ˜ì˜ íŒ€ ìˆœìœ„</h2>
            <table class="w-full text-5xl edit-table">
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th><th>íŒ€</th><th>ê²½ê¸°ìˆ˜</th><th>ìŠ¹</th><th>ë¬´</th><th>íŒ¨</th><th>ë“ì </th><th>ì‹¤ì </th><th>ë“ì‹¤ì°¨</th><th>ìŠ¹ë¥ </th><th>ìŠ¹ì </th>
                    </tr>
                </thead>
                <tbody>
                    ${teamsArray.map((t, index) => `
                        <tr>
                            <td class="font-bold">${index + 1}</td>
                            <td class="font-bold ${teamColorClasses[t.name]}">${t.name} ${index === 0 ? '<span>ğŸ†</span>' : ''}</td>
                            <td>${t.played}</td>
                            <td>${t.wins}</td>
                            <td>${t.draws}</td>
                            <td>${t.losses}</td>
                            <td>${t.gf}</td>
                            <td>${t.ga}</td>
                            <td>${t.gd > 0 ? `+${t.gd}` : t.gd}</td>
                            <td>${t.winRate}</td>
                            <td class="font-bold text-blue-400">${t.points}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;


    return tableHtml;
}


    // --- ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ëª¨ë‹¬ ì—´ê¸° ë“±) ---
    function openSelectNextTeamModal(drawingTeams, waitingTeam) {
        const container = document.getElementById('next-team-options');
        container.innerHTML = drawingTeams.map(tName => `<button data-action="select-next-team" data-team-name="${tName}" class="btn btn-primary text-3xl">${tName} íŒ€</button>`).join('');
        document.getElementById('select-next-team-modal').classList.remove('hidden');
    }


    function openConfirmNextMatchModal(team, suggestedTeams) {
        document.getElementById('consecutive-team-name').textContent = team;
        document.getElementById('consecutive-match-suggestion').textContent = `${suggestedTeams.join(' íŒ€ê³¼ ')} íŒ€ì´ ê²½ê¸°ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
        document.getElementById('confirm-next-match-modal').classList.remove('hidden');
    }


    // ë‚ ì§œ ë° êµ¬ì¥ëª… ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('game-date').addEventListener('change', (e) => {
        localState.selectedDate = e.target.value;
    });
    document.getElementById('field-select').addEventListener('change', (e) => {
        localState.selectedField = e.target.value;
    });
</script>
